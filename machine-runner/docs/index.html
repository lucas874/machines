<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@actyx/machine-runner</title><meta name="description" content="Documentation for @actyx/machine-runner"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script><script async src="assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">@actyx/machine-runner</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@actyx/machine-runner</h1></div><div class="tsd-panel tsd-typography"><h1 id="machine-runner" class="tsd-anchor-link">Machine Runner<a href="#machine-runner" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This library offers a TypeScript DSL for writing state machines and executing them in a fully decentralised fashion using the <a href="https://developer.actyx.com/">Actyx</a> peer-to-peer event stream database.
For an overview of the project this library is part of please refer to <a href="https://github.com/Actyx/machines">the GitHub repository</a>.</p>
<p>The detailed documentation of this library is provided in its JsDoc comments.</p>
<h2 id="example-usage" class="tsd-anchor-link">Example usage<a href="#example-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>We demonstrate the usage of our decentralized state machines on an example from manufacturing automation, i.e. the factory shop floor: a warehouse requests the fleet of logistics robots to pick something up and bring it somewhere else.
Our task is to write the logic for the warehouse and for each of the robots so that the job will eventually be done.
Since there are many robots we use an auction to settle who will do it.</p>
<h3 id="declaring-the-machines" class="tsd-anchor-link">Declaring the machines<a href="#declaring-the-machines" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>First we define our set of events:</p>
<pre><code class="typescript"><span class="hl-0">// sent by the warehouse to get things started</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">request</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;request&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-0">// sent by each available candidate transport robot to register interest</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">bid</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;bid&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">robot</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">delay</span><span class="hl-2">: </span><span class="hl-8">number</span><span class="hl-2">, </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-0">// sent by the transport robots</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">selected</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;selected&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">winner</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">, </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-0">// sent by the transport robot performing the delivery</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">deliver</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;deliver&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-0">// sent by the warehouse to acknowledge delivery</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">ack</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;acknowledge&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><br/><span class="hl-0">// declare a precisely typed tuple of all events we can now choose from</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">allEvents</span><span class="hl-2"> = [</span><span class="hl-5">request</span><span class="hl-2">, </span><span class="hl-5">bid</span><span class="hl-2">, </span><span class="hl-5">selected</span><span class="hl-2">, </span><span class="hl-5">deliver</span><span class="hl-2">, </span><span class="hl-5">ack</span><span class="hl-2">] </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-3">const</span>
</code><button type="button">Copy</button></pre>

<p>Then we can declare a swarm protocol using these events:</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">TransportOrder</span><span class="hl-2"> = </span><span class="hl-5">SwarmProtocol</span><span class="hl-2">.</span><span class="hl-6">make</span><span class="hl-2">(</span><span class="hl-7">&#39;warehouse-factory&#39;</span><span class="hl-2">, </span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">allEvents</span><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>Now we build two machines that participate in this protocol: the <code>warehouse</code> will request the material transport and acknowledge the delivery once it has taken place,
while the fleet of <code>robot</code> perform the material transport.</p>
<pre><code class="typescript"><span class="hl-0">// initialize the state machine builder for the `warehouse` role</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">Warehouse</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-5">TransportOrder</span><span class="hl-2">.</span><span class="hl-6">makeMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">)</span><br/><br/><span class="hl-0">// add initial state with command to request the transport</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">InitialWarehouse</span><span class="hl-2"> = </span><span class="hl-5">Warehouse</span><br/><span class="hl-2">  .</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;Initial&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;request&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">], (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">, </span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">, </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> [{ </span><span class="hl-5">id</span><span class="hl-2">, </span><span class="hl-5">from</span><span class="hl-2">, </span><span class="hl-5">to</span><span class="hl-2"> }])</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// add state entered after performing the request</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">AuctionWarehouse</span><span class="hl-2"> = </span><span class="hl-5">Warehouse</span><br/><span class="hl-2">  .</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;AuctionWarehouse&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// add state entered after a transport robot has been selected</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">SelectedWarehouse</span><span class="hl-2"> = </span><span class="hl-5">Warehouse</span><br/><span class="hl-2">  .</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;SelectedWarehouse&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// add state for acknowledging a delivery entered after a robot has performed the delivery</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">AcknowledgeWarehouse</span><span class="hl-2"> = </span><span class="hl-5">Warehouse</span><br/><span class="hl-2">  .</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;Acknowledge&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{</span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">}&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;acknowledge&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">], (</span><span class="hl-5">ctx</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> [{ </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2"> }])</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">DoneWarehouse</span><span class="hl-2"> = </span><span class="hl-5">Warehouse</span><span class="hl-2">.</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;Done&#39;</span><span class="hl-2">).</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// describe the transition into the `AuctionWarehouse` state after request has been made</span><br/><span class="hl-5">InitialWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">], </span><span class="hl-5">AuctionWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">_event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {})</span><br/><span class="hl-0">// describe the transitions from the `AuctionWarehouse` state</span><br/><span class="hl-5">AuctionWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">bid</span><span class="hl-2">], </span><span class="hl-5">AuctionWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">_event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {})</span><br/><span class="hl-5">AuctionWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">selected</span><span class="hl-2">], </span><span class="hl-5">SelectedWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">_event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {})</span><br/><span class="hl-0">// describe the transitions from the `SelectedWarehouse` state</span><br/><span class="hl-5">SelectedWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">deliver</span><span class="hl-2">], </span><span class="hl-5">AcknowledgeWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-5">AcknowledgeWarehouse</span><span class="hl-2">.</span><span class="hl-6">make</span><span class="hl-2">({</span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">event</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2">}))</span><br/><span class="hl-0">// describe the transitions from the `AcknoweledgeWarehouse` state</span><br/><span class="hl-5">AcknowledgeWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">], </span><span class="hl-5">DoneWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">_event</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {})</span>
</code><button type="button">Copy</button></pre>

<p>The <code>robot</code> state machine is constructed in the same way:</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">TransportRobot</span><span class="hl-2"> = </span><span class="hl-5">TransportOrder</span><span class="hl-2">.</span><span class="hl-6">makeMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;transporRobot&#39;</span><span class="hl-2">)</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">type</span><span class="hl-2"> </span><span class="hl-8">Score</span><span class="hl-2"> = { </span><span class="hl-5">robot</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">delay</span><span class="hl-2">: </span><span class="hl-8">number</span><span class="hl-2"> }</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">type</span><span class="hl-2"> </span><span class="hl-8">AuctionPayload</span><span class="hl-2"> =</span><br/><span class="hl-2">  { </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">robot</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">scores</span><span class="hl-2">: </span><span class="hl-8">Score</span><span class="hl-2">[] }</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">InitialTransport</span><span class="hl-2"> = </span><span class="hl-5">TransportRobot</span><span class="hl-2">.</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;Initial&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">robot</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">Auction</span><span class="hl-2"> = </span><span class="hl-5">TransportRobot</span><span class="hl-2">.</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;Auction&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;</span><span class="hl-8">AuctionPayload</span><span class="hl-2">&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;bid&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">bid</span><span class="hl-2">], (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">delay</span><span class="hl-2">: </span><span class="hl-8">number</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><br/><span class="hl-2">                         [{ </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2">, </span><span class="hl-5">delay</span><span class="hl-2">, </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2"> }])</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;select&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">selected</span><span class="hl-2">], (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">winner</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> [{ </span><span class="hl-5">winner</span><span class="hl-2">, </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2">}])</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">DoIt</span><span class="hl-2"> = </span><span class="hl-5">TransportRobot</span><span class="hl-2">.</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;DoIt&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">robot</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">; </span><span class="hl-5">winner</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">, </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;deliver&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">deliver</span><span class="hl-2">], (</span><span class="hl-5">ctx</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> [{ </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2"> }])</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">Done</span><span class="hl-2"> = </span><span class="hl-5">TransportRobot</span><span class="hl-2">.</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;Done&#39;</span><span class="hl-2">).</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// ingest the request from the `warehouse`</span><br/><span class="hl-5">InitialTransport</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">], </span><span class="hl-5">Auction</span><span class="hl-2">, (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">r</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> ({</span><br/><span class="hl-2">  </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">r</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">from:</span><span class="hl-2"> </span><span class="hl-5">r</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">from</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">to:</span><span class="hl-2"> </span><span class="hl-5">r</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">to</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">scores:</span><span class="hl-2"> []</span><br/><span class="hl-2">}))</span><br/><br/><span class="hl-0">// accumulate bids from all `robot`</span><br/><span class="hl-5">Auction</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">bid</span><span class="hl-2">], </span><span class="hl-5">Auction</span><span class="hl-2">, (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">b</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">scores</span><span class="hl-2">.</span><span class="hl-6">push</span><span class="hl-2">({</span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-5">b</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2">, </span><span class="hl-5">delay:</span><span class="hl-2"> </span><span class="hl-5">b</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">delay</span><span class="hl-2">})</span><br/><span class="hl-2">  </span><span class="hl-1">return</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><br/><span class="hl-2">})</span><br/><br/><span class="hl-0">// end the auction when a selection has happened</span><br/><span class="hl-5">Auction</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">selected</span><span class="hl-2">], </span><span class="hl-5">DoIt</span><span class="hl-2">, (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><br/><span class="hl-2">  ({ </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2">, </span><span class="hl-5">winner:</span><span class="hl-2"> </span><span class="hl-5">s</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">winner</span><span class="hl-2">, </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2"> }))</span><br/><br/><span class="hl-0">// go to the final state</span><br/><span class="hl-5">DoIt</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">deliver</span><span class="hl-2">], </span><span class="hl-5">Done</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {[]})</span>
</code><button type="button">Copy</button></pre>

<h3 id="checking-the-machines" class="tsd-anchor-link">Checking the machines<a href="#checking-the-machines" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><img src="https://raw.githubusercontent.com/lucas874/machines/refs/heads/update-packages/demos/warehouse-readme-demo/transport-order-protocol.svg" alt="transport order workflow" width="300" />
<p>The transport order workflow implemented in the previous section is visualized above as a UML state diagram.
With the <code>@actyx/machine-check</code> library we can check that this workflow makes sense (i.e. it achieves eventual consensus, which is the same kind of consensus used by the bitcoin network to settle transactions), and we can also check that our state machines written down in code implement this workflow correctly.</p>
<p>To this end, we first need to declare the graph in JSON notation:</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">transportOrderProtocol</span><span class="hl-2">: </span><span class="hl-8">SwarmProtocolType</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-5">initial:</span><span class="hl-2"> </span><span class="hl-7">&#39;initial&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">transitions:</span><span class="hl-2"> [</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;initial&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;auction&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> {</span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;request&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;auction&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;auction&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> {</span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;bid&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;transportRobot&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">bid</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;auction&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;delivery&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> {</span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;select&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;transportRobot&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">selected</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;delivery&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;delivered&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> {</span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;deliver&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;transportRobot&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">deliver</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;delivered&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;acknowledged&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> {</span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;acknowledge&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The naming of states does not need to be the same as in our code, but the event type names and the commands need to match.
With this preparation, we can perform the behavioral type checking as follows:</p>
<pre><code class="typescript"><span class="hl-1">import</span><span class="hl-2"> { </span><span class="hl-5">checkComposedProjection</span><span class="hl-2">, </span><span class="hl-5">checkComposedSwarmProtocol</span><span class="hl-2"> } </span><span class="hl-1">from</span><span class="hl-2"> </span><span class="hl-7">&#39;@actyx/machine-check&#39;</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">robotJSON</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-5">TransportOrderForRobot</span><span class="hl-2">.</span><span class="hl-6">createJSONForAnalysis</span><span class="hl-2">(</span><span class="hl-5">Initial</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">warehouseJSON</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-5">TransportOrderForWarehouse</span><span class="hl-2">.</span><span class="hl-6">createJSONForAnalysis</span><span class="hl-2">(</span><span class="hl-5">InitialWarehouse</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">subscriptions</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-5">robotJSON</span><span class="hl-2">.</span><span class="hl-5">subscriptions</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">warehouse:</span><span class="hl-2"> </span><span class="hl-5">warehouseJSON</span><span class="hl-2">.</span><span class="hl-5">subscriptions</span><span class="hl-2">,</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// these should all print `{ type: &#39;OK&#39; }`, otherwise there’s a mistake in</span><br/><span class="hl-0">// the code (you would normally verify this using your favorite unit</span><br/><span class="hl-0">// testing framework)</span><br/><span class="hl-5">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">checkComposedSwarmProtocol</span><span class="hl-2">([</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">], </span><span class="hl-5">subscriptions</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-6">checkComposedProjection</span><span class="hl-2">([</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">], </span><span class="hl-5">subscriptions</span><span class="hl-2">, </span><span class="hl-7">&#39;robot&#39;</span><span class="hl-2">, </span><span class="hl-5">robotJSON</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-6">checkComposedProjection</span><span class="hl-2">([</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">], </span><span class="hl-5">subscriptions</span><span class="hl-2">, </span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">, </span><span class="hl-5">warehouseJSON</span><span class="hl-2">),</span><br/><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<h3 id="running-the-machines" class="tsd-anchor-link">Running the machines<a href="#running-the-machines" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p><code>@actyx/machine-runner</code> relies upon <a href="https://developer.actyx.com">Actyx</a> for storing/retrieving events and sending them to other nodes in the swarm.
In other words, Actyx is the middleware that allows the <code>warehouse</code> and <code>robot</code> programs on different computers to talk to each other, in a fully decentralized peer-to-peer fashion and without further coordination — for maximum resilience and availability.
Therefore, before we can run our machines we need to use the Actyx SDK to connect to the local Actyx service:</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">actyx</span><span class="hl-2"> = </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">Actyx</span><span class="hl-2">.</span><span class="hl-6">of</span><span class="hl-2">(</span><br/><span class="hl-2">  { </span><span class="hl-5">appId:</span><span class="hl-2"> </span><span class="hl-7">&#39;com.example.warehouse-factory&#39;</span><span class="hl-2">, </span><span class="hl-5">displayName:</span><span class="hl-2"> </span><span class="hl-7">&#39;warehouse-factory&#39;</span><span class="hl-2">, </span><span class="hl-5">version:</span><span class="hl-2"> </span><span class="hl-7">&#39;1.0.0&#39;</span><span class="hl-2"> })</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">tags</span><span class="hl-2"> = </span><span class="hl-5">transportOrder</span><span class="hl-2">.</span><span class="hl-6">tagWithEntityId</span><span class="hl-2">(</span><span class="hl-7">&#39;warehouse-factory&#39;</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">transportRobot</span><span class="hl-2"> = </span><span class="hl-6">createMachineRunner</span><span class="hl-2">(</span><span class="hl-5">app</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">InitialTransport</span><span class="hl-2">, { </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-7">&quot;robotId&quot;</span><span class="hl-2"> })</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">warehouse</span><span class="hl-2"> = </span><span class="hl-6">createMachineRunner</span><span class="hl-2">(</span><span class="hl-5">app</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">InitialWarehouse</span><span class="hl-2">, </span><span class="hl-3">undefined</span><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>The <code>tags</code> can be thought of as the name of a <a href="https://developer.actyx.com/docs/conceptual/tags">dedicated pub–sub channel</a> for this particular workflow instance.
We demonstrate how to create both a robot and the warehouse, even though you probably won’t do that on the same computer in the real world.</p>
<p>Getting the process started means interacting with the state machines:</p>
<pre><code class="typescript"><span class="hl-1">for</span><span class="hl-2"> </span><span class="hl-1">await</span><span class="hl-2"> (</span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">state</span><span class="hl-2"> </span><span class="hl-3">of</span><span class="hl-2"> </span><span class="hl-5">warehouse</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">isLike</span><span class="hl-2">(</span><span class="hl-5">InitialWarehouse</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">cast</span><span class="hl-2">().</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">request</span><span class="hl-2">(</span><span class="hl-5">parts</span><span class="hl-2">[</span><span class="hl-5">Math</span><span class="hl-2">.</span><span class="hl-6">floor</span><span class="hl-2">(</span><span class="hl-5">Math</span><span class="hl-2">.</span><span class="hl-6">random</span><span class="hl-2">() * </span><span class="hl-5">parts</span><span class="hl-2">.</span><span class="hl-5">length</span><span class="hl-2">)], </span><span class="hl-7">&quot;a&quot;</span><span class="hl-2">, </span><span class="hl-7">&quot;b&quot;</span><span class="hl-2">)</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-5">isL</span><span class="hl-2"> </span><span class="hl-6">ike</span><span class="hl-2">(</span><span class="hl-5">AcknowledgeWarehouse</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">cast</span><span class="hl-2">().</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">acknowledge</span><span class="hl-2">()</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>warehouse</code> machine implements the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols#the_async_iterator_and_async_iterable_protocols">async iterator</a> JavaScript protocol, which makes it conveniently consumable using a <code>for await (...)</code> loop.
Exiting this loop, e.g. using <code>break</code> as shown below, will destroy the running machine, including cancelling the underlying Actyx event subscription for live updates.</p>
<p>Using the <code>robot</code> role we demonstrate a few more features of the machine runner:</p>
<pre><code class="typescript"><span class="hl-3">let</span><span class="hl-2"> </span><span class="hl-5">IamWinner</span><span class="hl-2"> = </span><span class="hl-3">false</span><br/><span class="hl-1">for</span><span class="hl-2"> </span><span class="hl-1">await</span><span class="hl-2"> (</span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">state</span><span class="hl-2"> </span><span class="hl-3">of</span><span class="hl-2"> </span><span class="hl-5">transportRobot</span><span class="hl-2">) {</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">isLike</span><span class="hl-2">(</span><span class="hl-5">Auction</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">auction</span><span class="hl-2"> = </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">cast</span><span class="hl-2">()</span><br/><span class="hl-2">    </span><span class="hl-1">if</span><span class="hl-2"> (!</span><span class="hl-5">auction</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">scores</span><span class="hl-2">.</span><span class="hl-6">find</span><span class="hl-2">((</span><span class="hl-5">s</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> </span><span class="hl-5">s</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2"> === </span><span class="hl-5">auction</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">robot</span><span class="hl-2">)) {</span><br/><br/><span class="hl-2">        </span><span class="hl-5">auction</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">bid</span><span class="hl-2">(</span><span class="hl-6">getRandomInt</span><span class="hl-2">(</span><span class="hl-9">1</span><span class="hl-2">, </span><span class="hl-9">10</span><span class="hl-2">))</span><br/><span class="hl-2">        </span><span class="hl-6">setTimeout</span><span class="hl-2">(() </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">            </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">stateAfterTimeOut</span><span class="hl-2"> = </span><span class="hl-5">transportRobot</span><span class="hl-2">.</span><span class="hl-6">get</span><span class="hl-2">()</span><br/><span class="hl-2">            </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">stateAfterTimeOut</span><span class="hl-2">?.</span><span class="hl-6">isLike</span><span class="hl-2">(</span><span class="hl-5">Auction</span><span class="hl-2">)) {</span><br/><span class="hl-2">                </span><span class="hl-5">stateAfterTimeOut</span><span class="hl-2">?.</span><span class="hl-6">cast</span><span class="hl-2">().</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">select</span><span class="hl-2">(</span><span class="hl-6">bestRobot</span><span class="hl-2">(</span><span class="hl-5">auction</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">scores</span><span class="hl-2">))</span><br/><span class="hl-2">            }</span><br/><span class="hl-2">        }, </span><span class="hl-9">3000</span><span class="hl-2">)</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">    } </span><span class="hl-1">else</span><span class="hl-2"> </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">isLike</span><span class="hl-2">(</span><span class="hl-5">DoIt</span><span class="hl-2">)) {</span><br/><span class="hl-2">        </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">assigned</span><span class="hl-2"> = </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">cast</span><span class="hl-2">()</span><br/><span class="hl-2">        </span><span class="hl-5">IamWinner</span><span class="hl-2"> = </span><span class="hl-5">assigned</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">winner</span><span class="hl-2"> === </span><span class="hl-5">assigned</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">robot</span><br/><span class="hl-2">        </span><span class="hl-1">if</span><span class="hl-2"> (!</span><span class="hl-5">IamWinner</span><span class="hl-2">) </span><span class="hl-1">break</span><br/><span class="hl-2">        </span><span class="hl-5">assigned</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">deliver</span><span class="hl-2">()</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The first one is that the accumulated state is inspected in the <code>state.isLike(Auction)</code> case to see whether this particular robot has already provided its bid for the auction.
If not, it will do so by invoking a command, which will subsequently lead to the emission of a <code>bid</code> event and consequently to a new state being emitted from the machine, so a new round through the <code>for await</code> loop — this time we’ll find our bid in the list, though.</p>
<p>The second part is that upon registering our bid, we also set a timer to expire after 5sec.
When that happens we synchronously check the <em>current</em> state of the workflow (since it will have changed, and if some other robot got to this part first, the auction may already be over).
If the workflow still is in the <code>Auction</code> state, we compute the best robot bid (the logic in <code>bestRobot</code> is where <em>your expertise</em> would go) and run the <code>select()</code> command to emit the corresponding event and end the auction.</p>
<p>The third feature becomes relevant once the auction has ended: we check if our robot is indeed the winner and record that in a variable <code>IamWinner</code>, i.e. in the current application in-memory state.
Then we can use this information in all following states as well.</p>
<h3 id="change-detection-on-for-await-loop" class="tsd-anchor-link">Change detection on for-await loop<a href="#change-detection-on-for-await-loop" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When using a for-await loop with the machine runner, the loop iterates only if all of the following criteria are met:</p>
<ul>
<li>A 'caughtUp' event is emitted; It happens when the machine runner receives the latest event published in Actyx;</li>
<li>An event between the current <code>caughtUp</code> and the previous one triggers a change to the machine's state; The state change is determined by comparing the name and payload between the state before and after the <code>caughtUp</code> event. The comparison uses the <code>deepEqual</code> function provided by the <a href="https://www.npmjs.com/package/fast-equals">fast-equal package</a>.</li>
</ul>
<h3 id="the-consequences-of-eventual-consensus" class="tsd-anchor-link">The consequences of Eventual Consensus<a href="#the-consequences-of-eventual-consensus" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The design goal of Actyx and the machine runner is to provide uncompromising resilience and availability, meaning that if a device is capable of computation it shall be able to make progress, independent of the network.
This implies that two devices that are not currently connected (which also includes the brief time lag introduced by ping times between them!) can make contradicting choices in a workflow.</p>
<p>In the example above, we deliberately didn’t use a <code>manager</code> or <code>referee</code> role to select the winner in the auction, since that decision maker would be a single-point-of-failure in the whole process.
Instead, each robot independently ensures that after at five seconds a decision will be made — even if two robots concurrently come to different conclusions and both emit a <code>selected</code> event.</p>
<p>Machine runner resolves this conflict by using only the <code>selected</code> event that comes first in the Actyx event sort order; in other words, Actyx arbitrarily picks a winner and the losing event is discarded.
If a robot saw itself winning, started the mission, and then discovers that its win turned out to be invalid, it will have to stop the mission and pick a new one.</p>
<h3 id="composing-swarms" class="tsd-anchor-link">Composing swarms<a href="#composing-swarms" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Suppose that the warehouse is part of a larger factory facility and that items from the warehouse are
needed on the assembly line. Instead of specifying a large workflow that combines the transport order
workflow with a description of how delivered items are used on the assembly line, and then implementing
the resulting workfow, we can reuse the transport order protocol and the machines that implement it.</p>
<img src="https://raw.githubusercontent.com/lucas874/machines/refs/heads/update-packages/demos/warehouse-readme-demo/assembly-protocol.svg" alt="assembly line workflow" width="300" />
<p>The workflow above specifies how the <code>warehouse</code> role requests an item and acknowledges its delivery, and how an <code>assemblyRobot</code>
uses the delivered item to assemble a product. Unlike the transport order workflow, this workflow does not specify
exactly how requested items are obtained. It simply states that an item can be requested and sometimes later its delivery can be acknowledged.</p>
<p>We can, however, implement the <code>assemblyRobot</code> for for the workflow above and then <strong>automatically adapt</strong> this machine
and the machines from the transport order protocol to work together. The resulting machines will then implement the workflow below:</p>
<p id="composition">
<img src="https://raw.githubusercontent.com/lucas874/machines/refs/heads/update-packages/demos/warehouse-readme-demo/composition.svg" alt="composed workflow" width="300" />
</p>
<p>To achieve this start by defining the event emitted by the assembly robot when a product has been finished.</p>
<pre><code class="typescript"><span class="hl-0">// the previously defined events</span><br/><br/><span class="hl-2">...</span><br/><br/><span class="hl-0">// sent by the assembly robot when a product has been assembled</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">product</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;product&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">    .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{</span><span class="hl-5">productName</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">}&gt;()</span><br/><br/><span class="hl-0">// declare a precisely typed tuple of all events we can now choose from</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">allEvents</span><span class="hl-2"> = [</span><span class="hl-5">request</span><span class="hl-2">, </span><span class="hl-5">bid</span><span class="hl-2">, </span><span class="hl-5">selected</span><span class="hl-2">, </span><span class="hl-5">deliver</span><span class="hl-2">, </span><span class="hl-5">ack</span><span class="hl-2">] </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-3">const</span>
</code><button type="button">Copy</button></pre>

<p>We then declare a new swarm protocol using these events:</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">AssemblyLine</span><span class="hl-2"> = </span><span class="hl-5">SwarmProtocol</span><span class="hl-2">.</span><span class="hl-6">make</span><span class="hl-2">(</span><span class="hl-7">&#39;warehouse-factory&#39;</span><span class="hl-2">, </span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">allEvents</span><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>Now we build the assembly robot for this protocol. Once an item has been delivered from the warehouse, it will use it to assemble a product.</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">AssemblyRobot</span><span class="hl-2"> = </span><span class="hl-5">AssemblyLine</span><span class="hl-2">.</span><span class="hl-6">makeMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;assemblyRobot&#39;</span><span class="hl-2">)</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">InitialAssemblyRobot</span><span class="hl-2"> = </span><span class="hl-5">AssemblyRobot</span><span class="hl-2">.</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;Initial&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">Assemble</span><span class="hl-2"> = </span><span class="hl-5">AssemblyRobot</span><span class="hl-2">.</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;Assemble&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{</span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">}&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;assemble&#39;</span><span class="hl-2">, [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">product</span><span class="hl-2">], (</span><span class="hl-5">_ctx</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><br/><span class="hl-2">                         [{ </span><span class="hl-5">productName:</span><span class="hl-2"> </span><span class="hl-7">&quot;product&quot;</span><span class="hl-2"> }])</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">Done</span><span class="hl-2"> = </span><span class="hl-5">AssemblyRobot</span><span class="hl-2">.</span><span class="hl-6">designEmpty</span><span class="hl-2">(</span><span class="hl-7">&#39;Done&#39;</span><span class="hl-2">).</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// ingest the request from the `warehouse`</span><br/><span class="hl-5">InitialAssemblyRobot</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">], </span><span class="hl-5">Assemble</span><span class="hl-2">, (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">a</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> ({</span><br/><span class="hl-2">  </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">a</span><span class="hl-2">.</span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">id</span><br/><span class="hl-2">}))</span><br/><br/><span class="hl-0">// go to the final state</span><br/><span class="hl-5">Assemble</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">product</span><span class="hl-2">], </span><span class="hl-5">Done</span><span class="hl-2">, (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">b</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {})</span>
</code><button type="button">Copy</button></pre>

<p>As with the transport order protocol, we can perform the behavioral type checking:</p>
<pre><code class="typescript"><span class="hl-1">import</span><span class="hl-2"> { </span><span class="hl-5">checkComposedProjection</span><span class="hl-2">, </span><span class="hl-5">checkComposedSwarmProtocol</span><span class="hl-2"> } </span><span class="hl-1">from</span><span class="hl-2"> </span><span class="hl-7">&#39;@actyx/machine-check&#39;</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">assemblyLineProtocol</span><span class="hl-2">: </span><span class="hl-8">SwarmProtocolType</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-5">initial:</span><span class="hl-2"> </span><span class="hl-7">&#39;initial&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">transitions:</span><span class="hl-2"> [</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;initial&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;wait&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> { </span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;request&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;wait&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;assemble&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> { </span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;acknowledge&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">]}},</span><br/><span class="hl-2">    {</span><span class="hl-5">source:</span><span class="hl-2"> </span><span class="hl-7">&#39;assemble&#39;</span><span class="hl-2">, </span><span class="hl-5">target:</span><span class="hl-2"> </span><span class="hl-7">&#39;done&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">      </span><span class="hl-5">label:</span><span class="hl-2"> { </span><span class="hl-5">cmd:</span><span class="hl-2"> </span><span class="hl-7">&#39;assemble&#39;</span><span class="hl-2">, </span><span class="hl-5">role:</span><span class="hl-2"> </span><span class="hl-7">&#39;assemblyRobot&#39;</span><span class="hl-2">, </span><span class="hl-5">logType:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">product</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">] }},</span><br/><span class="hl-2">  ]</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">assemblyRobotJSON</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-5">AssemblyRobot</span><span class="hl-2">.</span><span class="hl-6">createJSONForAnalysis</span><span class="hl-2">(</span><span class="hl-5">AssemblyRobotInitial</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">subscriptionsForAssemblyLine</span><span class="hl-2"> = {</span><br/><span class="hl-2">  </span><span class="hl-5">assemblyRobot:</span><span class="hl-2"> </span><span class="hl-5">assemblyRobotJSON</span><span class="hl-2">.</span><span class="hl-5">subscriptions</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">warehouse:</span><span class="hl-2"> [</span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">request</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">, </span><span class="hl-5">Events</span><span class="hl-2">.</span><span class="hl-5">ack</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2">],</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// these should all print `{ type: &#39;OK&#39; }`</span><br/><span class="hl-5">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-6">checkComposedSwarmProtocol</span><span class="hl-2">([</span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], </span><span class="hl-5">subscriptionsForAssemblyLine</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-6">checkComposedProjection</span><span class="hl-2">([</span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], </span><span class="hl-5">subscriptionsForAssemblyLine</span><span class="hl-2">, </span><span class="hl-7">&#39;assemblyRobot&#39;</span><span class="hl-2">, </span><span class="hl-5">assemblyRobotJSON</span><span class="hl-2">)</span><br/><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>To make the machines implemented for the transport order protocol and the assembly robot machine work together with we must <em>adapt</em> them to the <a href="#composition">composition
of the transport order and the assembly line protocols</a>.</p>
<p>We do this by first generating a subscription that works for the composed swarm:</p>
<pre><code class="typescript"><span class="hl-0">// subscription for the composed swarm</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">resultSubsComposition</span><span class="hl-2">: </span><span class="hl-8">DataResult</span><span class="hl-2">&lt;</span><span class="hl-8">Subscriptions</span><span class="hl-2">&gt;</span><br/><span class="hl-2">  = </span><span class="hl-6">overapproxWFSubscriptions</span><span class="hl-2">([</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">, </span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], {}, </span><span class="hl-7">&#39;TwoStep&#39;</span><span class="hl-2">)</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">resultSubsComposition</span><span class="hl-2">.</span><span class="hl-5">type</span><span class="hl-2"> === </span><span class="hl-7">&#39;ERROR&#39;</span><span class="hl-2">) </span><span class="hl-1">throw</span><span class="hl-2"> </span><span class="hl-3">new</span><span class="hl-2"> </span><span class="hl-6">Error</span><span class="hl-2">(</span><span class="hl-5">resultSubsComposition</span><span class="hl-2">.</span><span class="hl-5">errors</span><span class="hl-2">.</span><span class="hl-6">join</span><span class="hl-2">(</span><span class="hl-7">&#39;, &#39;</span><span class="hl-2">))</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">subscriptions</span><span class="hl-2">: </span><span class="hl-8">Subscriptions</span><span class="hl-2"> = </span><span class="hl-5">resultSubsComposition</span><span class="hl-2">.</span><span class="hl-5">data</span>
</code><button type="button">Copy</button></pre>

<p>Finally, using the subscription, we can adapt the machines and run them using <em>branch-tracking</em> MachineRunners:</p>
<pre><code class="typescript"><span class="hl-0">// Adapted machines.</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> [</span><span class="hl-4">assemblyRobotAdapted</span><span class="hl-2">, </span><span class="hl-4">initialAssemblyAdapted</span><span class="hl-2">] = </span><span class="hl-5">AssemblyProtocol</span><span class="hl-2">.</span><span class="hl-6">adaptMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;assemblyRobot&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  [</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">, </span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], </span><span class="hl-9">1</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">subscriptions</span><span class="hl-2">, [</span><span class="hl-5">AssemblyRobot</span><span class="hl-2">, </span><span class="hl-5">InitialAssemblyRobot</span><span class="hl-2">], </span><span class="hl-3">true</span><span class="hl-2">).</span><span class="hl-5">data</span><span class="hl-2">!</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> [</span><span class="hl-4">transportAdapted</span><span class="hl-2">, </span><span class="hl-4">initialTransportAdapted</span><span class="hl-2">] = </span><span class="hl-5">TransportOrder</span><span class="hl-2">.</span><span class="hl-6">adaptMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;transportRobot&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  [</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">, </span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], </span><span class="hl-9">0</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">subscriptions</span><span class="hl-2">, [</span><span class="hl-5">TransportRobot</span><span class="hl-2">, </span><span class="hl-5">InitialTransport</span><span class="hl-2">], </span><span class="hl-3">true</span><span class="hl-2">).</span><span class="hl-5">data</span><span class="hl-2">!</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> [</span><span class="hl-4">warehouseAdapted</span><span class="hl-2">, </span><span class="hl-4">warehouseInitialAdapted</span><span class="hl-2">] = </span><span class="hl-5">TransportOrder</span><span class="hl-2">.</span><span class="hl-6">adaptMachine</span><span class="hl-2">(</span><span class="hl-7">&#39;warehouse&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  [</span><span class="hl-5">transportOrderProtocol</span><span class="hl-2">, </span><span class="hl-5">assemblyLineProtocol</span><span class="hl-2">], </span><span class="hl-9">0</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">subscriptions</span><span class="hl-2">, [</span><span class="hl-5">Warehouse</span><span class="hl-2">, </span><span class="hl-5">InitialWarehouse</span><span class="hl-2">], </span><span class="hl-3">true</span><span class="hl-2">).</span><span class="hl-5">data</span><span class="hl-2">!</span><br/><br/><span class="hl-2">...</span><br/><br/><span class="hl-0">// Branch-tracking machine runners</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">assemblyRobot</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-6">createMachineRunnerBT</span><span class="hl-2">(</span><span class="hl-5">app</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">initialAssemblyAdapted</span><span class="hl-2">, </span><span class="hl-3">undefined</span><span class="hl-2">, </span><span class="hl-5">assemblyRobotAdapted</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">transportRobot</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-6">createMachineRunnerBT</span><span class="hl-2">(</span><span class="hl-5">app</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">initialTransportAdapted</span><span class="hl-2">, </span><span class="hl-5">initialPayload</span><span class="hl-2">, </span><span class="hl-5">transportAdapted</span><span class="hl-2">)</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">warehouse</span><span class="hl-2"> =</span><br/><span class="hl-2">  </span><span class="hl-6">createMachineRunnerBT</span><span class="hl-2">(</span><span class="hl-5">app</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">initialWarehouseAdapted</span><span class="hl-2">, </span><span class="hl-3">undefined</span><span class="hl-2">, </span><span class="hl-5">warehouseAdapted</span><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>For brevity in some of the examples above, code that resides in different files were shown together.
The full executable example outlined above is found <a href="https://github.com/lucas874/machines/tree/update-packages/demos/warehouse-readme-demo">here</a>.</p>
<h3 id="errors" class="tsd-anchor-link">Errors<a href="#errors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The following section describes various unavoidable errors that can arise due to the language design of JavaScript and TypeScript combined with the library's inherent distributed and asynchronous nature.</p>
<h4 id="errors-emittable-on-command-calls" class="tsd-anchor-link">Errors Emittable On Command Calls<a href="#errors-emittable-on-command-calls" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>A command call returns a promise. The promise's resolution marks the success of the events' publication to Actyx.</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">whenParticularState</span><span class="hl-2"> = </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">as</span><span class="hl-2">(</span><span class="hl-5">ParticularState</span><span class="hl-2">)</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">whenParticularState</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-0">// awaits the promise, which consequently may break the control flow if there is a thrown exception / promise rejection</span><br/><span class="hl-2">  </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">whenParticularState</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">someCommand</span><span class="hl-2">()</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>However, certain scenarios can result in async errors (i.e. a rejected promise) which will be explained momentarily.</p>
<p>To avoid errors, the general best practice is to not stash commands in an external variable and defer the call.
The <code>commands()</code> will return undefined when possible errors are detected.
The passing of time might have invalidated the detection result, which is the stashed value.</p>
<pre><code class="typescript"><span class="hl-0">// Good</span><br/><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">whenParticularState</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">someCommand</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// Bad</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">commands</span><span class="hl-2"> = </span><span class="hl-5">whenParticularState</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()</span><br/><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-6">someLongRunningTask</span><span class="hl-2">() </span><span class="hl-0">// this may have invalidated the error detection when finished executing</span><br/><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">commands</span><span class="hl-2">?.</span><span class="hl-6">someCommand</span><span class="hl-2">()</span>
</code><button type="button">Copy</button></pre>

<p>Avoid accidentally not issuing commands by using state objects produced by <code>next</code>,
<code>peek</code>, and <code>for-await</code> loop, as opposed to the <code>get</code> method. These methods
ensure the newly retrieved state objects are not expired. It is recommended to
only use <code>get</code> method when it is necessary to retrieve state objects immediately
(without waiting for the machine to finish processing the next event batch) at
the cost of possibly getting expired, locked, or non-caught-up state objects,
such as when observing a machine runner's state passively.</p>
<pre><code class="typescript"><span class="hl-0">// Guaranteed working, assuming there&#39;s no other</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">whenOn</span><span class="hl-2"> = (</span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">r</span><span class="hl-2">.</span><span class="hl-5">machine</span><span class="hl-2">.</span><span class="hl-6">peek</span><span class="hl-2">()).</span><span class="hl-5">value</span><span class="hl-2">?.</span><span class="hl-6">as</span><span class="hl-2">(</span><span class="hl-5">On</span><span class="hl-2">)</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">whenOn</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">whenOn</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">toggle</span><span class="hl-2">() </span><span class="hl-0">// returns promise</span><br/><span class="hl-2">}</span><br/><br/><span class="hl-0">// There&#39;s a chance that commands is not available</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">whenOn</span><span class="hl-2"> = </span><span class="hl-5">r</span><span class="hl-2">.</span><span class="hl-5">machine</span><span class="hl-2">.</span><span class="hl-6">get</span><span class="hl-2">().</span><span class="hl-5">value</span><span class="hl-2">?.</span><span class="hl-6">as</span><span class="hl-2">(</span><span class="hl-5">On</span><span class="hl-2">)</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">whenOn</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-5">whenOn</span><span class="hl-2">.</span><span class="hl-6">commands</span><span class="hl-2">()?.</span><span class="hl-6">toggle</span><span class="hl-2">() </span><span class="hl-0">// may be undefined</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The list of errors that may arise is as follows.</p>
<ul>
<li>
<p><code>MachineRunnerErrorCommandFiredAfterExpired</code>:</p>
<p>This error results from a command call to an expired state or a machine-runner with a non-empty event queue.</p>
<p>An &quot;Expired&quot; state object is a state object that does not match its machine-runner's current state object. An expired state object can be obtained by means of storing a state object's reference in a variable and using it at a later time when the machine-runner has transitioned to another state.</p>
<p>The non-empty event queue condition happens when a machine-runner is waiting for the completion of a multi-events transition. In a multi-events transition, different parts of this ordered events chain can arrive at different points in time. The queue is not empty in the period between the first and the last arrival.</p>
</li>
<li>
<p><code>MachineRunnerErrorCommandFiredAfterLocked</code>:</p>
<p>This error results from a command call to a locked state object/machine-runner. It is generally avoidable by not having a command being called twice in a concurrent fashion in the same state.</p>
<p>&quot;Locked&quot; is a transitionary state object/machine-runner between the time a command is called and it receives a rejection. When a command results in a failed publication, the source state objects are unlocked, thus subsequent commands will be available. When a command results in a successful publication, the machine-runner is unlocked, but the issuing state object is kept locked to prevent subsequent command calls. The machine-runner will immediately produce a new state object with commands enabled, accessible via <code>next</code>, <code>peek</code>, and <code>for-await</code> loop.</p>
</li>
<li>
<p><code>MachineRunnerErrorCommandFiredAfterDestroyed</code>:</p>
<p>This error results from a command call to a state object of a destroyed machine.</p>
<p>&quot;Destroyed&quot; is the status of a machine-runner that has been destroyed, either by explicitly calling its <code>.destroy()</code> method or by breaking out of the <code>for-await</code> that is applied to the runner.</p>
</li>
<li>
<p><code>MachineRunnerErrorCommandFiredWhenNotCaughtUp</code>:</p>
<p>This error results from a command call to a state object whose machine is not caught up.</p>
<p>&quot;Caught up&quot; is a state where a machine-runner has processed all published events in a subscription stream. Actyx sends events in batches. During the processing of a batch, the machine-runner is not caught up.</p>
</li>
</ul>
<h2 id="features" class="tsd-anchor-link">Features<a href="#features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="observe-changes-and-errors" class="tsd-anchor-link">Observe Changes and Errors<a href="#observe-changes-and-errors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>An alternative use case of a machine runner is to listen to its events.</p>
<p>The <code>next</code> event emits states whenever a new state is calculated.
When not using the machine, calling <code>destroy</code> is required to close the connection to Actyx.</p>
<pre><code class="typescript"><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">warehouse</span><span class="hl-2"> = </span><span class="hl-6">createMachineRunner</span><span class="hl-2">(</span><span class="hl-5">actyx</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">InitialWarehouse</span><span class="hl-2">, { </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-7">&#39;4711&#39;</span><span class="hl-2"> })</span><br/><br/><span class="hl-5">warehouse</span><span class="hl-2">.</span><span class="hl-5">events</span><span class="hl-2">.</span><span class="hl-6">on</span><span class="hl-2">(</span><span class="hl-7">&#39;next&#39;</span><span class="hl-2">, (</span><span class="hl-5">state</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-6">is</span><span class="hl-2">(</span><span class="hl-5">InitialWarehouse</span><span class="hl-2">)) {</span><br/><span class="hl-2">    </span><span class="hl-0">// ...</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">})</span><br/><br/><span class="hl-1">await</span><span class="hl-2"> </span><span class="hl-6">untilWareHouseIsNotUsedAnymore</span><span class="hl-2">()</span><br/><br/><span class="hl-5">warehouse</span><span class="hl-2">.</span><span class="hl-6">destroy</span><span class="hl-2">()</span>
</code><button type="button">Copy</button></pre>

<p><code>error</code> event can be used to capture errors from machine-runner.</p>
<pre><code><span class="hl-1">import</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-5">MachineRunnerErrorCommandFiredAfterLocked</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">MachineRunnerErrorCommandFiredAfterDestroyed</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">MachineRunnerErrorCommandFiredAfterExpired</span><span class="hl-2">,</span><br/><span class="hl-2">} </span><span class="hl-1">from</span><span class="hl-2"> </span><span class="hl-7">&quot;@actyx/machine-runner&quot;</span><br/><br/><span class="hl-5">warehouse</span><span class="hl-2">.</span><span class="hl-5">events</span><span class="hl-2">.</span><span class="hl-6">on</span><span class="hl-2">(</span><span class="hl-7">&#39;error&#39;</span><span class="hl-2">, (</span><span class="hl-5">error</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">error</span><span class="hl-2"> </span><span class="hl-3">instanceof</span><span class="hl-2"> </span><span class="hl-8">MachineRunnerErrorCommandFiredAfterLocked</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">//</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">error</span><span class="hl-2"> </span><span class="hl-3">instanceof</span><span class="hl-2"> </span><span class="hl-8">MachineRunnerErrorCommandFiredAfterDestroyed</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">//</span><br/><span class="hl-2">  }</span><br/><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">error</span><span class="hl-2"> </span><span class="hl-3">instanceof</span><span class="hl-2"> </span><span class="hl-8">MachineRunnerErrorCommandFiredAfterExpired</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">//</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">})</span>
</code><button>Copy</button></pre>

<h4 id="event-list" class="tsd-anchor-link">Event List<a href="#event-list" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><h5 id="next" class="tsd-anchor-link"><code>next</code><a href="#next" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p>A <code>next</code> event is emitted when a state transition happens and the machine runner has processed all events matching the supplied tag.</p>
<p>The payload is <code>StateOpaque</code>, similar to the value produced in the <code>for-await</code> loop.</p>
<h5 id="error" class="tsd-anchor-link"><code>error</code><a href="#error" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p>An <code>error</code> event is emitted when an error happened inside the runner. Currently this is the list of the errors:</p>
<ul>
<li>A command is called when locked i.e. another command is being issued in the same machine</li>
<li>A command is called when the corresponding state is expired i.e. another command has been successfully issued from that state</li>
<li>A command is called on a destroyed machine</li>
</ul>
<p>The payload has an error subtype.</p>
<h5 id="change" class="tsd-anchor-link"><code>change</code><a href="#change" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p>A <code>change</code> event is emitted when a <code>next</code> event is emitted, a command is issued, a command’s event has been published, or a subscription error happened due to losing a connection to Actyx.
This event is particularly useful in UI code where not only state changes are tracked, but also command availability and errors.</p>
<p>The payload is of type <code>StateOpaque</code>, like the value produced in the <code>for-await</code> loop.</p>
<h5 id="debugboottime" class="tsd-anchor-link"><code>debug.bootTime</code><a href="#debugboottime" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h5><p>A <code>debug.bootTime</code> event is emitted when a machine runner has caught up with its Actyx subscription (i.e. finished processing its events until the latest one) for the first time.</p>
<p>The payload includes information on the duration of the booting, the number of events processed, and the identity containing the swarm name, machine name, and tags.</p>
<pre><code class="typescript"><span class="hl-0">// Logs every time a machine booting takes more than 100 milliseconds or processed more than 100 events</span><br/><span class="hl-5">machine</span><span class="hl-2">.</span><span class="hl-5">events</span><span class="hl-2">.</span><span class="hl-6">on</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-7">&#39;debug.bootTime&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  ({ </span><span class="hl-5">durationMs</span><span class="hl-2">, </span><span class="hl-5">eventCount</span><span class="hl-2">, </span><span class="hl-5">identity</span><span class="hl-2">: { </span><span class="hl-5">machineName</span><span class="hl-2">, </span><span class="hl-5">swarmProtocolName</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2"> } }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">durationMs</span><span class="hl-2"> &gt; </span><span class="hl-9">100</span><span class="hl-2"> || </span><span class="hl-5">eventCount</span><span class="hl-2"> &gt; </span><span class="hl-9">100</span><span class="hl-2">) {</span><br/><span class="hl-2">      </span><span class="hl-5">console</span><span class="hl-2">.</span><span class="hl-6">warn</span><span class="hl-2">(</span><br/><span class="hl-2">        </span><span class="hl-7">`Boot of &quot;</span><span class="hl-3">${</span><span class="hl-5">swarmProtocolName</span><span class="hl-3">}</span><span class="hl-7">-</span><span class="hl-3">${</span><span class="hl-5">machineName</span><span class="hl-3">}</span><span class="hl-7">&quot; tagged &quot;</span><span class="hl-3">${</span><span class="hl-5">tags</span><span class="hl-10">.</span><span class="hl-6">toString</span><span class="hl-10">()</span><span class="hl-3">}</span><span class="hl-7">&quot; takes longer than usual (</span><span class="hl-3">${</span><span class="hl-5">durationMs</span><span class="hl-3">}</span><span class="hl-7"> milliseconds of to process </span><span class="hl-3">${</span><span class="hl-5">eventCount</span><span class="hl-3">}</span><span class="hl-7"> events)`</span><span class="hl-2">,</span><br/><span class="hl-2">      )</span><br/><span class="hl-2">    }</span><br/><span class="hl-2">  },</span><br/><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<h3 id="zod-on-machineevent" class="tsd-anchor-link">Zod on MachineEvent<a href="#zod-on-machineevent" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p><a href="https://zod.dev/">Zod</a> can be used to define and validate MachineEvents. On designing an event, use <code>withZod</code> instead of <code>withPayload</code>.</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">requested</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;requested&#39;</span><span class="hl-2">).</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{</span><br/><span class="hl-2">  </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><br/><span class="hl-2">  </span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-8">string</span><br/><span class="hl-2">  </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-8">string</span><br/><span class="hl-2">}&gt;()</span>
</code><button type="button">Copy</button></pre>

<p>The above code can be converted into:</p>
<pre><code class="typescript"><span class="hl-1">import</span><span class="hl-2"> </span><span class="hl-3">*</span><span class="hl-2"> </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2"> </span><span class="hl-1">from</span><span class="hl-2"> </span><span class="hl-7">&#39;zod&#39;</span><br/><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">requested</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;requested&#39;</span><span class="hl-2">).</span><span class="hl-6">withZod</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">object</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">    </span><span class="hl-5">from:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">    </span><span class="hl-5">to:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">  }),</span><br/><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>A zod-enabled event factory will have these additional features enabled:</p>
<ul>
<li>
<p>When receiving events from Actyx, a <code>MachineRunner</code> will compare the event payload to the embedded <code>ZodType</code>, in addition to the mandatory event type checking. Events that don't match the defined <code>MachineEvent</code> on the reaction will be ignored by the <code>MachineRunner</code>. For example, see the reaction definition below:</p>
<pre><code class="typescript"><span class="hl-5">InitialWarehouse</span><span class="hl-2">.</span><span class="hl-6">react</span><span class="hl-2">([</span><span class="hl-5">requested</span><span class="hl-2">], </span><span class="hl-5">DoneWarehouse</span><span class="hl-2">, (</span><span class="hl-5">_ctx</span><span class="hl-2">, </span><span class="hl-5">_r</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> [{}])</span>
</code><button type="button">Copy</button></pre>

<p>In a scenario where an incorrectly created event comes from Actyx <code>{ &quot;type&quot;: &quot;requested&quot;, id: &quot;some_id&quot; }</code>, the said event will not be regarded as valid and will be ignored.</p>
</li>
<li>
<p>When creating an event via the factory, which would be <code>requested.make</code> for the example above, an extra step will be taken to validate the payload. When the <code>make</code> method is called with an incorrect value, an exception will be thrown because internally <code>ZodType.parse</code> is used to validate the payload. For example:</p>
<pre><code class="typescript"><span class="hl-0">// Will throw because `{}` is not a valid value for the previously provided zod schema</span><br/><span class="hl-0">// But it takes `as any` to bypass TypeScript compiler in order to do this</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">singleEvent</span><span class="hl-2"> = </span><span class="hl-5">requested</span><span class="hl-2">.</span><span class="hl-6">make</span><span class="hl-2">({} </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-8">any</span><span class="hl-2">)</span>
</code><button type="button">Copy</button></pre>

<p>An extra care must be taken when the <code>ZodType</code> is <a href="https://zod.dev/?id=refine">refined</a>. In contrast to a mismatch in schema, a refined <code>ZodType</code> is not caught at compile-time. Therefore, a compilation process and IDE warnings is not sufficient to catch these errors. For example:</p>
<pre><code class="typescript"><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">requested</span><span class="hl-2"> = </span><span class="hl-5">MachineEvent</span><span class="hl-2">.</span><span class="hl-6">design</span><span class="hl-2">(</span><span class="hl-7">&#39;requested&#39;</span><span class="hl-2">).</span><span class="hl-6">withZod</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-5">z</span><br/><span class="hl-2">    .</span><span class="hl-6">object</span><span class="hl-2">({</span><br/><span class="hl-2">      </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">      </span><span class="hl-5">from:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">      </span><span class="hl-5">to:</span><span class="hl-2"> </span><span class="hl-5">z</span><span class="hl-2">.</span><span class="hl-6">string</span><span class="hl-2">(),</span><br/><span class="hl-2">    })</span><br/><span class="hl-2">    .</span><span class="hl-6">refine</span><span class="hl-2">((</span><span class="hl-5">payload</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">      </span><span class="hl-1">return</span><span class="hl-2"> </span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">from</span><span class="hl-2"> == </span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">to</span><br/><span class="hl-2">    }),</span><br/><span class="hl-2">)</span><br/><br/><span class="hl-0">// Will throw exception because `from` is same with `to`.</span><br/><span class="hl-0">// This mistake can&#39;t be caught by TypeScript compiler</span><br/><span class="hl-5">requested</span><span class="hl-2">.</span><span class="hl-6">make</span><span class="hl-2">({</span><br/><span class="hl-2">  </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-7">&#39;some_id&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">from:</span><span class="hl-2"> </span><span class="hl-7">&#39;some_location&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-5">to:</span><span class="hl-2"> </span><span class="hl-7">&#39;some_location&#39;</span><span class="hl-2">,</span><br/><span class="hl-2">})</span>
</code><button type="button">Copy</button></pre>

</li>
</ul>
<h3 id="global-event-emitter" class="tsd-anchor-link">Global Event Emitter<a href="#global-event-emitter" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Some global event emitters are provided.
These event emitters will emit events from all machine runners in the same process.</p>
<pre><code class="typescript"><span class="hl-1">import</span><span class="hl-2"> { </span><span class="hl-5">globals</span><span class="hl-2"> </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-5">machineRunnerGlobals</span><span class="hl-2"> } </span><span class="hl-1">from</span><span class="hl-2"> </span><span class="hl-7">&quot;@actyx/machine-runner&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-5">globals</span><span class="hl-2">.</span><span class="hl-5">emitter</span><span class="hl-2">.</span><span class="hl-6">addListener</span><span class="hl-2">(</span><span class="hl-7">&quot;debug.bootTime&quot;</span><span class="hl-2">, ({ </span><span class="hl-5">identity</span><span class="hl-2">, </span><span class="hl-5">durationMs</span><span class="hl-2">, </span><span class="hl-5">eventCount</span><span class="hl-2"> }) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">durationMs</span><span class="hl-2"> &gt; </span><span class="hl-9">100</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-5">console</span><span class="hl-2">.</span><span class="hl-6">warn</span><span class="hl-2">(</span><span class="hl-7">`</span><span class="hl-3">${</span><span class="hl-5">identity</span><span class="hl-3">}</span><span class="hl-7"> boot time takes more than 100ms (</span><span class="hl-3">${</span><span class="hl-5">durationMs</span><span class="hl-3">}</span><span class="hl-7">ms) processing </span><span class="hl-3">${</span><span class="hl-5">eventCount</span><span class="hl-3">}</span><span class="hl-7"> events`</span><span class="hl-2">);</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-5">globals</span><span class="hl-2">.</span><span class="hl-5">emitter</span><span class="hl-2">.</span><span class="hl-6">addListener</span><span class="hl-2">(</span><span class="hl-7">&quot;error&quot;</span><span class="hl-2">, </span><span class="hl-5">console</span><span class="hl-2">.</span><span class="hl-5">error</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="extra-tags" class="tsd-anchor-link">Extra Tags<a href="#extra-tags" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In the case extra tags are required to be attached in events when invoking commands, extra tags can be registered on a command definition. These extra tags will always be attached when the command is invoked.</p>
<pre><code class="typescript"><span class="hl-0">// State definition</span><br/><span class="hl-1">export</span><span class="hl-2"> </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">InitialWarehouse</span><span class="hl-2"> = </span><span class="hl-5">TransportOrderForWarehouse</span><span class="hl-2">.</span><span class="hl-6">designState</span><span class="hl-2">(</span><span class="hl-7">&#39;Initial&#39;</span><span class="hl-2">)</span><br/><span class="hl-2">  .</span><span class="hl-6">withPayload</span><span class="hl-2">&lt;{ </span><span class="hl-5">id</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2"> }&gt;()</span><br/><span class="hl-2">  .</span><span class="hl-6">command</span><span class="hl-2">(</span><span class="hl-7">&#39;request&#39;</span><span class="hl-2">, [</span><span class="hl-5">requested</span><span class="hl-2">], (</span><span class="hl-5">ctx</span><span class="hl-2">, </span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">, </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-8">string</span><span class="hl-2">) </span><span class="hl-3">=&gt;</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-1">return</span><span class="hl-2"> [</span><br/><span class="hl-2">      </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-6">withTags</span><span class="hl-2">(</span><br/><span class="hl-2">        [</span><span class="hl-7">`transport-order-from:</span><span class="hl-3">${</span><span class="hl-5">from</span><span class="hl-3">}</span><span class="hl-7">`</span><span class="hl-2">, </span><span class="hl-7">`transport-order-to:</span><span class="hl-3">${</span><span class="hl-5">to</span><span class="hl-3">}</span><span class="hl-7">`</span><span class="hl-2">],</span><br/><span class="hl-2">        { </span><span class="hl-5">id:</span><span class="hl-2"> </span><span class="hl-5">ctx</span><span class="hl-2">.</span><span class="hl-5">self</span><span class="hl-2">.</span><span class="hl-5">id</span><span class="hl-2">, </span><span class="hl-5">from</span><span class="hl-2">, </span><span class="hl-5">to</span><span class="hl-2"> }</span><br/><span class="hl-2">      )</span><br/><span class="hl-2">    ]</span><br/><span class="hl-2">  })</span><br/><span class="hl-2">  .</span><span class="hl-6">finish</span><span class="hl-2">()</span><br/><br/><span class="hl-0">// Command call</span><br/><span class="hl-0">// The resulting events will include the extra tags</span><br/><span class="hl-0">// `transport-order-from:${from}`,</span><br/><span class="hl-0">// `transport-order-to:${to}`</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">stateAsInitialWarehouse</span><span class="hl-2"> = </span><span class="hl-5">state</span><br/><span class="hl-2">  .</span><span class="hl-6">as</span><span class="hl-2">(</span><span class="hl-5">InitialWarehouse</span><span class="hl-2">)?</span><br/><span class="hl-2">  .</span><span class="hl-6">commands</span><span class="hl-2">()?</span><br/><span class="hl-2">  .</span><span class="hl-6">request</span><span class="hl-2">(</span><span class="hl-5">from</span><span class="hl-2">: </span><span class="hl-7">`source`</span><span class="hl-2">, </span><span class="hl-5">to</span><span class="hl-2">: </span><span class="hl-7">`destination`</span><span class="hl-2">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="refinestatetype" class="tsd-anchor-link"><code>refineStateType</code><a href="#refinestatetype" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>A <code>MachineRunner</code> instance now has a new method available: <code>refineStateType</code> which return a new aliasing machine.
State payload produced by the returned machine is typed as the <strong>union of all possible payload types</strong> instead of <code>unknown</code>.
The union is useful to be used in combination with <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html">type-narrowing</a>.</p>
<p>Usage example:</p>
<pre><code class="typescript"><span class="hl-0">// States defined in previous examples</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">allStates</span><span class="hl-2"> = [</span><span class="hl-5">Initial</span><span class="hl-2">, </span><span class="hl-5">Auction</span><span class="hl-2">, </span><span class="hl-5">DoIt</span><span class="hl-2">] </span><span class="hl-1">as</span><span class="hl-2"> </span><span class="hl-3">const</span><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">machine</span><span class="hl-2"> = </span><span class="hl-6">createMachineRunner</span><span class="hl-2">(</span><span class="hl-5">actyx</span><span class="hl-2">, </span><span class="hl-5">tags</span><span class="hl-2">, </span><span class="hl-5">Initial</span><span class="hl-2">, { </span><span class="hl-5">robot:</span><span class="hl-2"> </span><span class="hl-7">&#39;agv1&#39;</span><span class="hl-2"> }).</span><span class="hl-6">refineStateType</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-5">allStates</span><span class="hl-2">,</span><br/><span class="hl-2">)</span><br/><br/><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">state</span><span class="hl-2"> = </span><span class="hl-5">machine</span><span class="hl-2">.</span><span class="hl-6">get</span><span class="hl-2">()</span><br/><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-5">state</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">payload</span><span class="hl-2"> = </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-5">payload</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Equals to:</span><br/><span class="hl-2">  </span><span class="hl-0">//  | { robot: string }</span><br/><span class="hl-2">  </span><span class="hl-0">//  | { id: string; from: string; to: string; robot: string; scores: Score[] }</span><br/><span class="hl-2">  </span><span class="hl-0">//  | { robot: string; winner: string }</span><br/><span class="hl-2">  </span><span class="hl-3">type</span><span class="hl-2"> </span><span class="hl-8">PayloadType</span><span class="hl-2"> = </span><span class="hl-3">typeof</span><span class="hl-2"> </span><span class="hl-5">state</span><span class="hl-2">.</span><span class="hl-5">payload</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// &#39;robot&#39; property is accessible directly because it is available in all variants</span><br/><span class="hl-2">  </span><span class="hl-3">const</span><span class="hl-2"> </span><span class="hl-4">robot</span><span class="hl-2"> = </span><span class="hl-5">payload</span><span class="hl-2">.</span><span class="hl-5">robot</span><br/><br/><span class="hl-2">  </span><span class="hl-0">// Used with type-narrowing</span><br/><span class="hl-2">  </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-7">&#39;winner&#39;</span><span class="hl-2"> </span><span class="hl-3">in</span><span class="hl-2"> </span><span class="hl-5">payload</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">// here the type of payload is narrowed to { robot: string; winner: string }</span><br/><span class="hl-2">  } </span><span class="hl-1">else</span><span class="hl-2"> </span><span class="hl-1">if</span><span class="hl-2"> (</span><span class="hl-7">&#39;id&#39;</span><span class="hl-2"> </span><span class="hl-3">in</span><span class="hl-2"> </span><span class="hl-5">payload</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-0">// here the type of payload is narrowed to { id: string; from: string; to: string; robot: string; scores: Score[] }</span><br/><span class="hl-2">  } </span><span class="hl-1">else</span><span class="hl-2"> {</span><br/><span class="hl-2">    </span><span class="hl-0">// here the type of payload is narrowed to { robot: string }</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code><button type="button">Copy</button></pre>

<p>The argument to <code>.refineStateType</code> must be an array containing all previously defined states.
Any other argument will throw an error.</p>
<p>The aliasing machine shares the original machine's internal state.
All method calls, such as <code>.destroy</code>, create the same effect as when enacted on the original machine.</p>
<h2 id="developer-support" class="tsd-anchor-link">Developer support<a href="#developer-support" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>If you have any questions, suggestions, or just want to chat with other interested folks, you’re welcome to join our discord chat. Please find a current invitation link on <a href="https://developer.actyx.com/">the top right of the Actyx docs page</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#machine-runner"><span>Machine <wbr/>Runner</span></a><ul><li><a href="#example-usage"><span>Example usage</span></a></li><li><ul><li><a href="#declaring-the-machines"><span>Declaring the machines</span></a></li><li><a href="#checking-the-machines"><span>Checking the machines</span></a></li><li><a href="#running-the-machines"><span>Running the machines</span></a></li><li><a href="#change-detection-on-for-await-loop"><span>Change detection on for-<wbr/>await loop</span></a></li><li><a href="#the-consequences-of-eventual-consensus"><span>The consequences of <wbr/>Eventual <wbr/>Consensus</span></a></li><li><a href="#composing-swarms"><span>Composing swarms</span></a></li><li><a href="#errors"><span>Errors</span></a></li><li><ul><li><a href="#errors-emittable-on-command-calls"><span>Errors <wbr/>Emittable <wbr/>On <wbr/>Command <wbr/>Calls</span></a></li></ul></li></ul></li><li><a href="#features"><span>Features</span></a></li><li><ul><li><a href="#observe-changes-and-errors"><span>Observe <wbr/>Changes and <wbr/>Errors</span></a></li><li><ul><li><a href="#event-list"><span>Event <wbr/>List</span></a></li><li><ul><li><a href="#next"><span>next</span></a></li><li><a href="#error"><span>error</span></a></li><li><a href="#change"><span>change</span></a></li><li><a href="#debugboottime"><span>debug.boot<wbr/>Time</span></a></li></ul></li></ul></li><li><a href="#zod-on-machineevent"><span>Zod on <wbr/>Machine<wbr/>Event</span></a></li><li><a href="#global-event-emitter"><span>Global <wbr/>Event <wbr/>Emitter</span></a></li><li><a href="#extra-tags"><span>Extra <wbr/>Tags</span></a></li><li><a href="#refinestatetype"><span>refine<wbr/>State<wbr/>Type</span></a></li></ul></li><li><a href="#developer-support"><span>Developer support</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@actyx/machine-runner</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
