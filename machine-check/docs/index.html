<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@actyx/machine-check</title><meta name="description" content="Documentation for @actyx/machine-check"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">@actyx/machine-check</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@actyx/machine-check</h1></div><div class="tsd-panel tsd-typography"><h1 id="machine-check" class="tsd-anchor-link">Machine Check<a href="#machine-check" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This library allows you to check whether the machines you implement with <a href="https://www.npmjs.com/package/@actyx/machine-runner">machine-runner</a> comply with a correct overall swarm behaviour.
Before we dive into how to use it, we need to quickly establish some notation.</p>
<h2 id="swarm-protocols" class="tsd-anchor-link">Swarm Protocols<a href="#swarm-protocols" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Just like the workflow diagrams you put on a whiteboard to discuss how your product should work, we describe swarm behaviour in terms of a <a href="https://en.wikipedia.org/wiki/Finite-state_machine"><em>state machine</em></a>.
This is a fancy word for saying that we start with an initial state and whenever something happens we follow an arrow on the diagram to get to the next state.
Sometimes there are several choices for what can happen next, meaning that the protocol can proceed via one of several charted paths; these can loop back to an earlier state or rejoin to move forward together later.</p>
<p>TODO: <em>add graph</em></p>
<p>While the graphical representation is much nicer, we need a textual representation for writing things down (e.g. in error messages).
Besides naming the initial state, this is just a list of transitions, where each one consists of the following:</p>
<ul>
<li>the state we start from, e.g. <code>(Closed)</code></li>
<li>the name of the command that needs to be invoked to start the transition, e.g. <code>open</code></li>
<li>the name of the machine role that is allowed to issue this command, e.g. <code>Control</code></li>
<li>a list of event types that record this transition, e.g. <code>Opening</code></li>
<li>the state we thus arrive at, e.g. <code>(Opening)</code></li>
</ul>
<p>The short form for writing this down is <code>(Closed) --[open@Control&lt;Opening&gt;]--&gt; (Opening)</code></p>
<h2 id="example-protocol" class="tsd-anchor-link">Example protocol<a href="#example-protocol" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The machines from the <a href="media/README.md#example-usage">Hangar Door example</a> might follow this protocol:</p>
<ul>
<li><code>(Closed) --[open@Control&lt;opening&gt;]--&gt; (Opening)</code></li>
<li><code>(Opening) --[update@Door&lt;opening&gt;]--&gt; (Opening)</code></li>
<li><code>(Opening) --[open@Door&lt;opened&gt;]--&gt; (Open)</code></li>
<li><code>(Open) --[close@Control&lt;closing&gt;]--&gt; (Closing)</code></li>
<li><code>(Closing) --[update@Door&lt;closing&gt;]--&gt; (Closing)</code></li>
<li><code>(Closing) --[close@Door&lt;closed&gt;]--&gt; (Closed)</code></li>
</ul>
<p>The Control can initiate opening and closing while the Door provides progress updates and states when each movement has been completed.</p>
<h2 id="how-to-use-this-library" class="tsd-anchor-link">How to use this library<a href="#how-to-use-this-library" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>This library is typically used within your unit tests to check the structure of the machines youâ€™ve written.
For this we need to provide two pieces: the desired swarm protocol and the event subscriptions of your machine roles.
Continuing the example above, it could look like this:</p>
<pre><code class="ts"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">Door</span><span class="hl-1">, </span><span class="hl-2">Control</span><span class="hl-1">, </span><span class="hl-2">HangarBay</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;./example-proto.js&#39;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">SwarmProtocolType</span><span class="hl-1">, </span><span class="hl-2">checkProjection</span><span class="hl-1">, </span><span class="hl-2">checkSwarmProtocol</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;@actyx/machine-check&#39;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">swarmProtocol</span><span class="hl-1">: </span><span class="hl-6">SwarmProtocolType</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-2">initial:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">transitions:</span><span class="hl-1"> [</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Opening&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;open&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Control&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;opening&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Opening&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Opening&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;update&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Door&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;opening&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Opening&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Open&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;open&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Door&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;opened&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Open&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closing&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;close&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Control&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;closing&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closing&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closing&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;update&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Door&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;closing&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    {</span><br/><span class="hl-1">      </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closing&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">target:</span><span class="hl-1"> </span><span class="hl-3">&#39;Closed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-2">label:</span><span class="hl-1"> { </span><span class="hl-2">cmd:</span><span class="hl-1"> </span><span class="hl-3">&#39;close&#39;</span><span class="hl-1">, </span><span class="hl-2">role:</span><span class="hl-1"> </span><span class="hl-3">&#39;Door&#39;</span><span class="hl-1">, </span><span class="hl-2">logType:</span><span class="hl-1"> [</span><span class="hl-3">&#39;closed&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  ],</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">subscriptions</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-2">Control:</span><span class="hl-1"> [</span><span class="hl-3">&#39;closing&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;closed&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;opening&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;opened&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-2">Door:</span><span class="hl-1"> [</span><span class="hl-3">&#39;closing&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;closed&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;opening&#39;</span><span class="hl-1">, </span><span class="hl-3">&#39;opened&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>The <code>swarmProtocol</code> describes the expected flow of events, written down as if we had full oversight or all machines that will later implement it.
And this is how we run the behaviour checker to first make sure that the swarm protocol is valid and then check that our machines implement it correctly:</p>
<pre><code class="ts"><span class="hl-7">describe</span><span class="hl-1">(</span><span class="hl-3">&#39;swarmProtocol&#39;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">it</span><span class="hl-1">(</span><span class="hl-3">&#39;should be well-formed&#39;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">expect</span><span class="hl-1">(</span><span class="hl-7">checkSwarmProtocol</span><span class="hl-1">(</span><span class="hl-2">swarmProtocol</span><span class="hl-1">, </span><span class="hl-2">subscriptions</span><span class="hl-1">)).</span><span class="hl-7">toEqual</span><span class="hl-1">({ </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&#39;OK&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  </span><span class="hl-7">it</span><span class="hl-1">(</span><span class="hl-3">&#39;should match Control&#39;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">expect</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-7">checkProjection</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">swarmProtocol</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">subscriptions</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-3">&#39;Control&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">Control</span><span class="hl-1">.</span><span class="hl-2">Control</span><span class="hl-1">.</span><span class="hl-7">createJSONForAnalysis</span><span class="hl-1">(</span><span class="hl-2">Control</span><span class="hl-1">.</span><span class="hl-2">Closed</span><span class="hl-1">),</span><br/><span class="hl-1">      ),</span><br/><span class="hl-1">    ).</span><span class="hl-7">toEqual</span><span class="hl-1">({ </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&#39;OK&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  </span><span class="hl-7">it</span><span class="hl-1">(</span><span class="hl-3">&#39;should match Door&#39;</span><span class="hl-1">, () </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-7">expect</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-7">checkProjection</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">swarmProtocol</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">subscriptions</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-3">&#39;Door&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">Door</span><span class="hl-1">.</span><span class="hl-2">Door</span><span class="hl-1">.</span><span class="hl-7">createJSONForAnalysis</span><span class="hl-1">(</span><span class="hl-2">Door</span><span class="hl-1">.</span><span class="hl-2">Closed</span><span class="hl-1">),</span><br/><span class="hl-1">      ),</span><br/><span class="hl-1">    ).</span><span class="hl-7">toEqual</span><span class="hl-1">({ </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&#39;OK&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">})</span>
</code><button type="button">Copy</button></pre>

<p>You can of course use any testing framework you like.
In the example as given youâ€™ll be notified that the overall protocol has a flaw:</p>
<pre><code class="text">{
  type: &#39;ERROR&#39;,
  errors: [
    &#39;guard event type opening appears in transitions from multiple states&#39;,
    &#39;guard event type closing appears in transitions from multiple states&#39;
  ]
}
</code><button type="button">Copy</button></pre>

<p>This means that our clever reuse of the <code>opening</code> and <code>closing</code> event types for dual purposes (i.e. as transition to a moving door as well as progress update) may not be so clever after allâ€Šâ€”â€Šthe <code>update</code> commands should yield more specific <code>openingProgress</code> and <code>closingProgress</code> event types instead.
Other than that, our machines are implemented correctly.
You can try to remove a command or reaction from the code to observe how this this pointed out by <code>checkProjection()</code>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#machine-check"><span>Machine <wbr/>Check</span></a><ul><li><a href="#swarm-protocols"><span>Swarm <wbr/>Protocols</span></a></li><li><a href="#example-protocol"><span>Example protocol</span></a></li><li><a href="#how-to-use-this-library"><span>How to use this library</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@actyx/machine-check</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
